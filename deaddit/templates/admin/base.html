<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin{% endblock %} - Deaddit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .navbar-brand {
            padding-top: .75rem;
            padding-bottom: .75rem;
        }
        
        .navbar .form-control {
            padding: .75rem 1rem;
            border-width: 0;
            border-radius: 0;
        }
        
        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
        }
        
        .sidebar .nav-link .bi {
            margin-right: 4px;
            color: #999;
        }
        
        .sidebar .nav-link.active {
            color: #007bff;
        }
        
        .sidebar .nav-link:hover .bi,
        .sidebar .nav-link.active .bi {
            color: inherit;
        }
        
        .sidebar-heading {
            font-size: .75rem;
            text-transform: uppercase;
        }
        
        main {
            margin-left: 240px;
            padding: 20px;
        }
        
        .feather {
            width: 16px;
            height: 16px;
            vertical-align: text-bottom;
        }
        
        .job-status-pending { color: #6c757d; }
        .job-status-running { color: #007bff; }
        .job-status-completed { color: #28a745; }
        .job-status-failed { color: #dc3545; }
        .job-status-cancelled { color: #6c757d; }
        
        .progress-bar-striped.active {
            animation: progress-bar-stripes 2s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            from { background-position: 40px 0; }
            to { background-position: 0 0; }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="{{ url_for('admin.dashboard') }}">
            <i class="bi bi-gear-fill"></i> Deaddit Admin
        </a>
        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="bi bi-house-door"></i> Back to Site
                </a>
            </li>
        </ul>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}" 
                               href="{{ url_for('admin.dashboard') }}">
                                <i class="bi bi-speedometer2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.generate' %}active{% endif %}" 
                               href="{{ url_for('admin.generate') }}">
                                <i class="bi bi-plus-circle"></i>
                                Generate Content
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint in ['admin.jobs', 'admin.job_detail'] %}active{% endif %}" 
                               href="{{ url_for('admin.jobs') }}">
                                <i class="bi bi-list-task"></i>
                                Jobs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.content' %}active{% endif %}" 
                               href="{{ url_for('admin.content') }}">
                                <i class="bi bi-file-text"></i>
                                Content
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.analytics' %}active{% endif %}" 
                               href="{{ url_for('admin.analytics') }}">
                                <i class="bi bi-graph-up"></i>
                                Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin.settings' %}active{% endif %}" 
                               href="{{ url_for('admin.settings') }}">
                                <i class="bi bi-gear"></i>
                                Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // Initialize WebSocket connection for real-time updates
        const socket = io('/admin');
        let isConnected = false;
        
        socket.on('connect', function() {
            console.log('Connected to admin WebSocket');
            isConnected = true;
            
            // Join job updates room
            socket.emit('join_job_updates', {});
            
            // Show connection indicator
            showConnectionStatus('Connected', 'success');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from admin WebSocket');
            isConnected = false;
            showConnectionStatus('Disconnected', 'danger');
        });
        
        socket.on('job_update', function(data) {
            console.log('Received job update:', data);
            updateJobUI(data);
        });
        
        function showConnectionStatus(message, type) {
            // Create or update connection status indicator
            let indicator = document.getElementById('ws-connection-status');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'ws-connection-status';
                indicator.className = 'position-fixed top-0 end-0 m-3';
                indicator.style.zIndex = '9999';
                document.body.appendChild(indicator);
            }
            
            indicator.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="bi bi-wifi"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    const alert = indicator.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 3000);
            }
        }
        
        function updateJobUI(jobData) {
            const jobId = jobData.job_id;
            
            // Update status elements
            const statusElements = document.querySelectorAll(`[data-job-id="${jobId}"]`);
            statusElements.forEach(element => {
                element.className = `job-status-${jobData.status}`;
                element.innerHTML = `
                    <i class="bi bi-${getStatusIcon(jobData.status)}"></i>
                    ${jobData.status.toUpperCase()}
                `;
            });
            
            // Update progress bars
            const progressBars = document.querySelectorAll(`[data-job-progress="${jobId}"]`);
            progressBars.forEach(progressBar => {
                if (jobData.total_items > 0) {
                    const percentage = Math.round((jobData.progress / jobData.total_items) * 100);
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = `${jobData.progress}/${jobData.total_items}`;
                    
                    // Add animation for running jobs
                    if (jobData.status === 'running') {
                        progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
                    } else {
                        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    }
                }
            });
            
            // Update error messages
            if (jobData.error_message) {
                const errorElements = document.querySelectorAll(`[data-job-error="${jobId}"]`);
                errorElements.forEach(element => {
                    element.textContent = jobData.error_message;
                    element.style.display = 'block';
                });
            }
            
            // Show completion notifications
            if (jobData.status === 'completed') {
                showJobNotification(`Job ${jobId} completed successfully!`, 'success');
            } else if (jobData.status === 'failed') {
                showJobNotification(`Job ${jobId} failed: ${jobData.error_message}`, 'danger');
            }
        }
        
        function getStatusIcon(status) {
            const icons = {
                'pending': 'clock',
                'running': 'play-circle',
                'completed': 'check-circle',
                'failed': 'x-circle',
                'cancelled': 'dash-circle'
            };
            return icons[status] || 'question-circle';
        }
        
        function showJobNotification(message, type) {
            // Create notification toast
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            
            toastContainer.insertAdjacentHTML('beforeend', `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // Fallback polling for when WebSocket is not connected
        function refreshJobStatus() {
            if (isConnected) return; // Skip if WebSocket is working
            
            const statusElements = document.querySelectorAll('[data-job-id]');
            statusElements.forEach(element => {
                const jobId = element.getAttribute('data-job-id');
                fetch(`/admin/api/jobs/${jobId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status) {
                            updateJobUI({
                                job_id: parseInt(jobId),
                                status: data.status,
                                progress: data.progress || 0,
                                total_items: data.total_items || 1,
                                error_message: data.error_message
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching job status:', error));
            });
        }

        // Fallback refresh every 10 seconds (only when WebSocket is disconnected)
        setInterval(refreshJobStatus, 10000);
        
        // Refresh stats on dashboard
        function refreshStats() {
            if (window.location.pathname === '/admin/' || window.location.pathname === '/admin/dashboard') {
                fetch('/admin/api/jobs/stats')
                    .then(response => response.json())
                    .then(data => {
                        const updateStat = (id, value) => {
                            const element = document.getElementById(id);
                            if (element) element.textContent = value;
                        };
                        
                        if (data.database) {
                            updateStat('pending-jobs', data.database.pending);
                            updateStat('running-jobs', data.database.running);
                            updateStat('completed-jobs', data.database.completed);
                            updateStat('failed-jobs', data.database.failed);
                        }
                    })
                    .catch(error => console.error('Error fetching stats:', error));
            }
        }

        // Refresh stats every 30 seconds
        setInterval(refreshStats, 30000);
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>