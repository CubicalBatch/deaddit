{% extends "admin/base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Settings & Configuration</h1>
</div>

<!-- OpenAI Configuration -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-robot"></i> OpenAI Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="openai-config-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai_api_url" class="form-label">
                                    API Endpoint URL <span class="text-danger">*</span>
                                </label>
                                <input type="url" class="form-control" id="openai_api_url" name="openai_api_url" 
                                       value="{{ config.openai_api_url if config.openai_api_url != 'Not set' else '' }}" 
                                       placeholder="http://localhost:11434/v1" required>
                                <div class="form-text">The base URL for your OpenAI-compatible API</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai_key" class="form-label">
                                    API Key <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="openai_key" name="openai_key" 
                                           placeholder="Enter API key" required
                                           {% if config.openai_key_set %}value="••••••••••••••••"{% endif %}>
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('openai_key')">
                                        <i class="bi bi-eye" id="openai_key_toggle_icon"></i>
                                    </button>
                                </div>
                                <div class="form-text">Your API authentication key</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai_model" class="form-label">Default Model</label>
                                <div class="input-group">
                                    <select class="form-select" id="openai_model" name="openai_model">
                                        <option value="">Select a model...</option>
                                        {% if config.openai_model != 'Not set' %}
                                        <option value="{{ config.openai_model }}" selected>{{ config.openai_model }}</option>
                                        {% endif %}
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" onclick="loadAvailableModels(this)">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="form-text">Default model name for content generation</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="api_base_url" class="form-label">Application Base URL</label>
                                <input type="url" class="form-control" id="api_base_url" name="api_base_url" 
                                       value="{{ config.api_base_url if config.api_base_url != 'Not set' else '' }}" 
                                       placeholder="http://localhost:5000">
                                <div class="form-text">Base URL for internal API calls</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Save Configuration
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                    <i class="bi bi-wifi"></i> Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Connection Test Results -->
                <div id="connection-test-result" class="mt-3" style="display: none;"></div>
                
            </div>
        </div>
    </div>
</div>

<!-- Current Configuration Status -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Configuration Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4" id="api-url-status">
                                {% if config.openai_api_url != "Not set" %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i>
                                {% endif %}
                            </div>
                            <small class="text-muted">API URL</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4" id="api-key-status">
                                {% if config.openai_key_set %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-x-circle text-danger"></i>
                                {% endif %}
                            </div>
                            <small class="text-muted">API Key</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4" id="model-status">
                                {% if config.openai_model != "Not set" %}
                                    <i class="bi bi-check-circle text-success"></i>
                                {% else %}
                                    <i class="bi bi-exclamation-triangle text-warning"></i>
                                {% endif %}
                            </div>
                            <small class="text-muted">Default Model</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4" id="connection-status">
                                <i class="bi bi-question-circle text-muted"></i>
                            </div>
                            <small class="text-muted">Connection</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Scheduler Status -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock"></i> Job Scheduler
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <div id="scheduler-status">
                            <span class="badge bg-success">Running</span>
                            <small class="text-muted d-block">APScheduler</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Active Jobs</h6>
                        <div id="active-jobs-count">
                            <span class="h4">-</span>
                            <small class="text-muted d-block">Loading...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-database"></i> Database
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Location</h6>
                        <p><code>instance/deaddit.db</code></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Type</h6>
                        <p>SQLite</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Environment Variables Guide -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-text"></i> Environment Configuration
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure these environment variables in your <code>.env</code> file:</p>
                
                <div class="accordion" id="envAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="requiredHeader">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#requiredCollapse">
                                Required Settings
                            </button>
                        </h2>
                        <div id="requiredCollapse" class="accordion-collapse collapse show" data-bs-parent="#envAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Description</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>OPENAI_API_URL</code></td>
                                            <td>AI service endpoint URL</td>
                                            <td><code>http://localhost:11434/v1</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>OPENAI_KEY</code></td>
                                            <td>API authentication key</td>
                                            <td><code>your-api-key-here</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="optionalHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#optionalCollapse">
                                Optional Settings
                            </button>
                        </h2>
                        <div id="optionalCollapse" class="accordion-collapse collapse" data-bs-parent="#envAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>OPENAI_MODEL</code></td>
                                            <td>Default model name</td>
                                            <td><code>llama3</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>MODELS</code></td>
                                            <td>Comma-separated list of available models</td>
                                            <td><code>llama3,gpt-4</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>API_TOKEN</code></td>
                                            <td>Bearer token for API protection</td>
                                            <td><em>None (public access)</em></td>
                                        </tr>
                                        <tr>
                                            <td><code>API_BASE_URL</code></td>
                                            <td>Base URL for the application API</td>
                                            <td><code>http://localhost:5000</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flaskHeader">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flaskCollapse">
                                Flask Settings
                            </button>
                        </h2>
                        <div id="flaskCollapse" class="accordion-collapse collapse" data-bs-parent="#envAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>FLASK_ENV</code></td>
                                            <td>Environment mode</td>
                                            <td><code>development</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>FLASK_DEBUG</code></td>
                                            <td>Enable debug mode</td>
                                            <td><code>True</code></td>
                                        </tr>
                                        <tr>
                                            <td><code>SECRET_KEY</code></td>
                                            <td>Flask session secret key</td>
                                            <td><code>dev-secret-key</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> System Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6>Python Version</h6>
                        <p id="python-version">Loading...</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Flask Version</h6>
                        <p id="flask-version">Loading...</p>
                    </div>
                    <div class="col-md-3">
                        <h6>SQLAlchemy Version</h6>
                        <p id="sqlalchemy-version">Loading...</p>
                    </div>
                    <div class="col-md-3">
                        <h6>APScheduler Version</h6>
                        <p id="apscheduler-version">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-tools"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="testConnection()">
                            <i class="bi bi-wifi"></i> Test API Connection
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Stats
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('admin.jobs') }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-list-task"></i> View All Jobs
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('admin.generate') }}" class="btn btn-outline-warning w-100">
                            <i class="bi bi-plus-circle"></i> Create New Job
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load system information
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();
    loadSchedulerStats();
    
    // Set up form submission
    document.getElementById('openai-config-form').addEventListener('submit', saveConfiguration);
});

function loadSystemInfo() {
    fetch('/admin/api/system-info')
        .then(response => response.json())
        .then(data => {
            document.getElementById('python-version').textContent = data.python_version || 'Unknown';
            document.getElementById('flask-version').textContent = data.flask_version || 'Unknown';
            document.getElementById('sqlalchemy-version').textContent = data.sqlalchemy_version || 'Unknown';
            document.getElementById('apscheduler-version').textContent = data.apscheduler_version || 'Unknown';
        })
        .catch(error => {
            console.error('Error loading system info:', error);
            document.getElementById('python-version').textContent = 'Error loading';
            document.getElementById('flask-version').textContent = 'Error loading';
            document.getElementById('sqlalchemy-version').textContent = 'Error loading';
            document.getElementById('apscheduler-version').textContent = 'Error loading';
        });
}

function loadSchedulerStats() {
    fetch('/admin/api/jobs/stats')
        .then(response => response.json())
        .then(data => {
            const status = data.scheduler_running ? 'Running' : 'Stopped';
            const statusClass = data.scheduler_running ? 'bg-success' : 'bg-danger';
            
            document.getElementById('scheduler-status').innerHTML = `
                <span class="badge ${statusClass}">${status}</span>
                <small class="text-muted d-block">APScheduler</small>
            `;
            
            const activeJobs = data.database ? data.database.running : 0;
            document.getElementById('active-jobs-count').innerHTML = `
                <span class="h4">${activeJobs}</span>
                <small class="text-muted d-block">Running</small>
            `;
        })
        .catch(error => {
            console.error('Error loading scheduler stats:', error);
            document.getElementById('scheduler-status').innerHTML = `
                <span class="badge bg-secondary">Unknown</span>
                <small class="text-muted d-block">Error loading</small>
            `;
            document.getElementById('active-jobs-count').innerHTML = `
                <span class="h4">-</span>
                <small class="text-muted d-block">Error loading</small>
            `;
        });
}

function saveConfiguration(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        openai_api_url: formData.get('openai_api_url'),
        openai_key: formData.get('openai_key'),
        openai_model: formData.get('openai_model'),
        api_base_url: formData.get('api_base_url')
    };
    
    // Don't send masked password
    if (data.openai_key === '••••••••••••••••') {
        delete data.openai_key;
    }
    
    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    submitButton.disabled = true;
    
    fetch('/admin/api/save-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('<i class="bi bi-check-circle"></i> Configuration saved successfully!', 'alert-success');
            updateConfigurationStatus(data.config);
        } else {
            showAlert('<i class="bi bi-x-circle"></i> Failed to save configuration: ' + data.message, 'alert-danger');
        }
    })
    .catch(error => {
        showAlert('<i class="bi bi-x-circle"></i> Error saving configuration: ' + error.message, 'alert-danger');
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

function testConnection() {
    const apiUrl = document.getElementById('openai_api_url').value;
    const apiKey = document.getElementById('openai_key').value;
    
    if (!apiUrl) {
        showAlert('<i class="bi bi-exclamation-triangle"></i> Please enter an API URL first', 'alert-warning');
        return;
    }
    
    // Allow testing with masked key (will use saved environment variable)
    if (!apiKey) {
        showAlert('<i class="bi bi-exclamation-triangle"></i> Please enter an API key first', 'alert-warning');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
    button.disabled = true;
    
    const data = {
        api_url: apiUrl,
        api_key: apiKey
    };
    
    fetch('/admin/api/test-connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        displayConnectionTestResult(data);
        updateConnectionStatus(data.success);
    })
    .catch(error => {
        const errorResult = {
            success: false,
            message: 'Connection test failed: ' + error.message,
            status_code: null
        };
        displayConnectionTestResult(errorResult);
        updateConnectionStatus(false);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function displayConnectionTestResult(data) {
    const resultDiv = document.getElementById('connection-test-result');
    const alertClass = data.success ? 'alert-success' : 'alert-danger';
    const icon = data.success ? 'check-circle' : 'x-circle';
    
    let statusCodeBadge = '';
    if (data.status_code !== null && data.status_code !== undefined) {
        const badgeClass = data.status_code >= 200 && data.status_code < 300 ? 'bg-success' : 'bg-danger';
        statusCodeBadge = `<span class="badge ${badgeClass} ms-2">HTTP ${data.status_code}</span>`;
    }
    
    resultDiv.innerHTML = `
        <div class="alert ${alertClass}" role="alert">
            <i class="bi bi-${icon}"></i> ${data.message}${statusCodeBadge}
        </div>
    `;
    resultDiv.style.display = 'block';
}

function loadAvailableModels(buttonElement) {
    const apiUrl = document.getElementById('openai_api_url').value;
    const apiKey = document.getElementById('openai_key').value;
    
    if (!apiUrl) {
        showAlert('<i class="bi bi-exclamation-triangle"></i> Please enter API URL first', 'alert-warning');
        return;
    }
    
    // Allow loading models with masked key (will use saved environment variable)
    if (!apiKey) {
        showAlert('<i class="bi bi-exclamation-triangle"></i> Please enter an API key first', 'alert-warning');
        return;
    }
    
    // Get button element - either from parameter or find the refresh button
    const button = buttonElement || document.querySelector('button[onclick*="loadAvailableModels"]');
    if (!button) {
        console.error('Could not find refresh button');
        return;
    }
    
    const icon = button.querySelector('i');
    const originalIcon = icon ? icon.className : 'bi bi-arrow-clockwise';
    
    if (icon) {
        icon.className = 'bi bi-hourglass-split';
    }
    button.disabled = true;
    
    const data = {
        api_url: apiUrl,
        api_key: apiKey
    };
    
    fetch('/admin/api/load-models', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateModelsDropdown(data.models);
            showAlert('<i class="bi bi-check-circle"></i> Loaded ' + data.models.length + ' models', 'alert-success');
        } else {
            showAlert('<i class="bi bi-x-circle"></i> Failed to load models: ' + data.message, 'alert-danger');
        }
    })
    .catch(error => {
        showAlert('<i class="bi bi-x-circle"></i> Error loading models: ' + error.message, 'alert-danger');
    })
    .finally(() => {
        if (icon) {
            icon.className = originalIcon;
        }
        button.disabled = false;
    });
}

function populateModelsDropdown(models) {
    const dropdown = document.getElementById('openai_model');
    const currentValue = dropdown.value;
    
    // Clear existing options except the first one
    dropdown.innerHTML = '<option value="">Select a model...</option>';
    
    if (models && models.length > 0) {
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.textContent = model;
            if (model === currentValue) {
                option.selected = true;
            }
            dropdown.appendChild(option);
        });
    }
}

function updateConfigurationStatus(config) {
    // Update status indicators
    const updateStatus = (elementId, isSet) => {
        const element = document.getElementById(elementId);
        if (isSet) {
            element.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
        } else {
            element.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
        }
    };
    
    updateStatus('api-url-status', config.openai_api_url && config.openai_api_url !== 'Not set');
    updateStatus('api-key-status', config.openai_key_set);
    updateStatus('model-status', config.openai_model && config.openai_model !== 'Not set');
}

function updateConnectionStatus(success) {
    const element = document.getElementById('connection-status');
    if (success) {
        element.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
    } else {
        element.innerHTML = '<i class="bi bi-x-circle text-danger"></i>';
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '_toggle_icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function refreshStats() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Refreshing...';
    button.disabled = true;
    
    loadSystemInfo();
    loadSchedulerStats();
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        showAlert('<i class="bi bi-check-circle"></i> Stats refreshed successfully', 'alert-success');
    }, 1000);
}

function showAlert(message, alertClass) {
    const alertContainer = document.createElement('div');
    alertContainer.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    alertContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertContainer);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertContainer.parentNode) {
            const alert = new bootstrap.Alert(alertContainer);
            alert.close();
        }
    }, 5000);
}
</script>
{% endblock %}